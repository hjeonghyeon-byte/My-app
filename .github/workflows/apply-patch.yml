name: apply-patch

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: "Base branch"
        required: true
        default: "main"
      pr_title:
        description: "PR title"
        required: true
        default: "Auto patch from n8n"
      patch_b64:
        description: "Base64-encoded patch (optional)"
        required: false
        default: ""
      required_files:
        description: "JSON array of required files to exist after apply (optional)"
        required: false
        default: "[]"
      must_create:
        description: "JSON array of files that must be newly created (optional)"
        required: false
        default: "[]"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create work branch
        id: mkbranch
        run: |
          set -euo pipefail
          BR="auto/patch-${{ github.run_id }}"
          git switch -c "$BR"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"

      - name: Apply patch if provided
        id: apply
        env:
          PATCH_B64: ${{ inputs.patch_b64 }}
          REQUIRED_FILES: ${{ inputs.required_files }}
          MUST_CREATE: ${{ inputs.must_create }}
        shell: bash
        run: |
          set -eo pipefail
          DID_APPLY="false"

          if [ -n "${PATCH_B64:-}" ]; then
            echo "[info] patch_b64 length: $(printf '%s' "$PATCH_B64" | wc -c)"
            printf '%s' "$PATCH_B64" | tr -d '\r\n' | base64 -d > patch.diff 2> decode.err || true
            sed -i 's/\r$//' patch.diff || true

            python3 - <<'PY'
import json, os
open('.rf.list','w').write('\n'.join(json.loads(os.environ.get('REQUIRED_FILES','[]'))))
open('.mc.list','w').write('\n'.join(json.loads(os.environ.get('MUST_CREATE','[]'))))
PY
            mapfile -t RF < .rf.list || true
            mapfile -t MC < .mc.list || true

            if [ ${#RF[@]} -gt 0 ]; then
              for f in "${RF[@]}"; do
                grep -q -E "^(diff --git a/${f} b/${f}|\+\+\+ b/${f})$" patch.diff || echo "::warning ::Required file not present in diff (pre-apply): $f"
              done
            fi
            if [ ${#MC[@]} -gt 0 ]; then
              for f in "${MC[@]}"; do
                (grep -q -E "^\+\+\+ b/${f}$" patch.diff && grep -q -E "^--- /dev/null$" patch.diff) || echo "::warning ::Must-create header not found (pre-apply): $f"
              done
            fi

            echo "[preview top 20]"; head -n 20 patch.diff || true
            echo "[preview bottom 20]"; tail -n 20 patch.diff || true

            for P in 0 1; do
              if git apply --check --whitespace=nowarn -p${P} patch.diff 2> apply_check.err; then
                if git apply --index --whitespace=nowarn -p${P} patch.diff 2> apply.err; then
                  DID_APPLY="true"
                  echo "[info] git apply -p${P} succeeded"
                  break
                fi
              fi
            done

            if [ "$DID_APPLY" != "true" ] && command -v patch >/dev/null 2>&1; then
              for P in 0 1; do
                if patch -p${P} -f -s < patch.diff; then
                  git add -A
                  DID_APPLY="true"
                  echo "[info] patch -p${P} succeeded"
                  break
                fi
              done
            fi

            if [ "$DID_APPLY" = "true" ]; then
              echo "[git status --porcelain]"; git status --porcelain || true
              echo "[git diff --cached --name-status]"; git diff --cached --name-status || true
              if [ ${#RF[@]} -gt 0 ]; then
                for f in "${RF[@]}"; do
                  if ! test -f "$f"; then
                    echo "::error ::Required file missing after apply: $f"
                    exit 1
                  fi
                done
              fi
            else
              echo "::warning ::Patch application failed. Committing patch.diff and debug logs."
              mkdir -p .n8n-debug || true
              [ -s decode.err ] && mv decode.err .n8n-debug/ || true
              [ -s apply_check.err ] && mv apply_check.err .n8n-debug/ || true
              [ -s apply.err ] && mv apply.err .n8n-debug/ || true
              git add patch.diff .n8n-debug || true
            fi
          fi

          echo "did_apply=$DID_APPLY" >> "$GITHUB_OUTPUT"

      - name: Ensure at least one change
        run: |
          set -euo pipefail
          {
            echo "run_id=${{ github.run_id }}"
            echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          } >> .n8n-diagnose.txt
          git add .n8n-diagnose.txt

      - name: Commit if changes exist
        id: commit
        run: |
          set -euo pipefail
          if ! git diff --cached --quiet; then
            git commit -m "${{ inputs.pr_title }}"
            echo "did_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "No staged changes; skip commit."
            echo "did_commit=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure git auth uses token
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"

      - name: Push branch
        if: steps.commit.outputs.did_commit == 'true'
        run: |
          set -euo pipefail
          git push -u origin "${{ steps.mkbranch.outputs.branch }}"

      - name: Create Pull Request
        if: steps.commit.outputs.did_commit == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr create \
            --head "${{ steps.mkbranch.outputs.branch }}" \
            --base "${{ inputs.base_branch }}" \
            --title "${{ inputs.pr_title }}" \
            --body "Automated patch via workflow run ${{ github.run_id }}"


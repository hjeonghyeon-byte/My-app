name: apply-and-pr

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch'
        required: true
        default: main
      pr_title:
        description: 'PR title'
        required: true
        default: 'Auto patch from n8n'
      patch_b64:
        description: 'Base64-encoded patch (optional)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.base_branch }}

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BR="auto/patch-${{ github.run_id }}"
          git checkout -b "$BR"

      # patch_b64 가 비어있지 않을 때만 실행
      - name: Apply patch if provided
        if: ${{ github.event.inputs.patch_b64 && github.event.inputs.patch_b64 != '' }}
        shell: bash
        run: |
          set -euo pipefail
          # CR/LF 섞여 들어온 인코딩 깨짐 방지
          printf '%s' "${{ github.event.inputs.patch_b64 }}" | tr -d '\r\n' | base64 -d > patch.diff
          # 먼저 검증
          if git apply --ignore-whitespace --check patch.diff; then
            git apply --ignore-whitespace --index patch.diff
          else
            echo "::warning title=git apply failed::retry with -p1"
            git apply -p1 --ignore-whitespace --index patch.diff
          fi

      - name: Commit changes if any
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "Auto patch from n8n"
          fi

      - name: Push branch
        run: |
          BR="auto/patch-${{ github.run_id }}"
          git push -u origin "$BR"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BR="auto/patch-${{ github.run_id }}"
          gh pr create \
            --title "${{ github.event.inputs.pr_title }}" \
            --body  "Automated patch from n8n" \
            --base  "${{ github.event.inputs.base_branch }}" \
            --head  "$BR" || true

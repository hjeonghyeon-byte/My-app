name: apply-and-pr

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch'
        required: true
        default: 'main'
      pr_title:
        description: 'PR title'
        required: true
        default: 'Auto patch from n8n'
      patch_b64:
        description: 'Base64-encoded patch (optional)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ✅ 새 작업 브랜치 생성/스위치 (한 번만)
      - name: Create work branch
        id: mkbranch
        shell: bash
        run: |
          set -euo pipefail
          BR="auto/patch-${{ github.run_id }}"
          git fetch --all
          git switch -c "$BR" || git checkout -b "$BR"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"

      # (옵션) n8n에서 넘어온 patch_b64 적용
      - name: Apply patch if provided
        id: apply
        shell: bash
        run: |
          set -euo pipefail
          DID_APPLY="false"
          if [ -n "${{ inputs.patch_b64 }}" ]; then
            printf "%s" "${{ inputs.patch_b64 }}" | tr -d '\r\n' | base64 -d > patch.diff
            echo "[preview]"; head -n 50 patch.diff || true
            if git apply --check --whitespace=nowarn patch.diff; then
              git apply --index --whitespace=nowarn patch.diff
              DID_APPLY="true"
            else
              if git apply --check --whitespace=nowarn -p1 patch.diff; then
                git apply --index --whitespace=nowarn -p1 patch.diff
                DID_APPLY="true"
              else
                echo "::error::git apply failed"
                exit 1
              fi
            fi
          fi
          echo "did_apply=$DID_APPLY" >> "$GITHUB_OUTPUT"

      # ✅ 변경 0건이어도 PR이 생기도록 최소 1개 변경 보장
      - name: Ensure at least one change
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "run_id=${{ github.run_id }}"
            echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          } >> .n8n-diagnose.txt
          git add .n8n-diagnose.txt

      # ✅ 커밋 (누락됐던 fi 추가 완료)
      - name: Commit if changes exist
        id: commit
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --cached --quiet; then
            git commit -m "${{ inputs.pr_title }}"
            echo "did_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "No staged changes; skip commit."
            echo "did_commit=false" >> "$GITHUB_OUTPUT"
          fi

      # ✅ 커밋된 경우에만 push
      - name: Push branch
        if: steps.commit.outputs.did_commit == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git push -u origin "${{ steps.mkbranch.outputs.branch }}"

      # ✅ 커밋된 경우에만 PR 생성
      - name: Create Pull Request
        if: steps.commit.outputs.did_commit == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh pr create \
            --head "${{ steps.mkbranch.outputs.branch }}" \
            --base "${{ inputs.base_branch }}" \
            --title "${{ inputs.pr_title }}" \
            --body "Automated patch via workflow run ${{ github.run_id }}"

name: Apply Patch
on:
  workflow_dispatch:
    inputs:
      patch_b64:
        description: 'Base64 encoded patch'
        required: true
      base_branch:
        description: 'Base branch to apply patch'
        required: true
      pr_title:
        description: 'PR title'
        required: false
        default: 'Auto patch from n8n'

jobs:
  apply-patch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.base_branch }}

      - name: Create working branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b auto/patch-${{ github.run_id }}

      - name: Decode and apply patch
        run: |
          echo "${{ github.event.inputs.patch_b64 }}" | base64 -d > patch.diff
          dos2unix patch.diff
          if ! git apply --check patch.diff; then
            echo "Patch apply failed, creating diagnostic file" > .n8n-diagnose.txt
            echo "Patch content:" >> .n8n-diagnose.txt
            cat patch.diff >> .n8n-diagnose.txt
            echo "Trying patch -p0" >> .n8n-diagnose.txt
            patch -p0 < patch.diff || echo "patch -p0 failed" >> .n8n-diagnose.txt
            echo "Trying patch -p1" >> .n8n-diagnose.txt
            patch -p1 < patch.diff || echo "patch -p1 failed" >> .n8n-diagnose.txt
            git add .n8n-diagnose.txt
            git commit -m "Add diagnostic file for failed patch"
          else
            git apply --ignore-whitespace patch.diff
            git add .
            git commit -m "${{ github.event.inputs.pr_title }}"
          fi

      - name: Push changes
        run: |
          git push origin auto/patch-${{ github.run_id }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: ${{ github.event.inputs.pr_title }}
          branch: auto/patch-${{ github.run_id }}
          base: ${{ github.event.inputs.base_branch }}
          title: ${{ github.event.inputs.pr_title }}
          body: "Automated patch from n8n. Check .n8n-diagnose.txt if patch failed."
name: Apply Patch and Open PR (n8n)

on:
  workflow_dispatch:
    inputs:
      patch_b64:
        description: Base64-encoded unified diff
        required: true
      base_branch:
        description: Base branch to create PR against
        required: true
        default: main
      pr_title:
        description: Title of the PR
        required: true
        default: Auto patch from n8n

permissions:
  contents: write
  pull-requests: write
  issues: write 
jobs:
  apply-patch:
    runs-on: ubuntu-latest
    env:
      BASE_BRANCH: ${{ github.event.inputs.base_branch }}
      PATCH_B64: ${{ github.event.inputs.patch_b64 }}
      PR_TITLE: ${{ github.event.inputs.pr_title }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}
          fetch-depth: 0

      - name: Install utils
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix patch

      - name: Prepare work branch
        id: prep
        run: |
          BR="auto/patch-${{ github.run_id }}"
          echo "BRANCH_NAME=$BR" >> $GITHUB_OUTPUT
          git checkout -b "$BR"

      - name: Decode base64 → patch.diff (LF normalize)
        id: decode
        shell: bash
        run: |
          # 1) 공백/개행 정리
          CLEAN=$(printf "%s" "${PATCH_B64}" | tr -d '\r\n\t ')
          # 2) base64 디코드
          echo "$CLEAN" | base64 -d > patch.diff || {
            echo "Base64 decode failed" >&2
            exit 1
          }
          dos2unix patch.diff || true
          echo "==== patch.diff head ===="
          head -n 50 patch.diff || true

      - name: Try git apply (diff --git style)
        id: git_apply
        continue-on-error: true
        run: |
          set -e
          # git apply는 diff --git 포맷에 적합
          git apply --whitespace=nowarn --reject --index patch.diff
        shell: bash

      - name: Fallback to patch -p0 / -p1
        id: patch_apply
        if: steps.git_apply.outcome == 'failure'
        continue-on-error: true
        run: |
          set -e
          # patch 명령은 일반 unified diff에 적합
          # -p0 먼저 시도, 실패하면 -p1 시도
          if patch -p0 --forward < patch.diff; then
            echo "patch -p0 succeeded"
          elif patch -p1 --forward < patch.diff; then
            echo "patch -p1 succeeded"
          else
            echo "both patch attempts failed" >&2
            exit 1
          fi
          # patch 명령은 인덱스 갱신을 안 하므로 수동으로 stage
          git add -A
        shell: bash

      - name: Diagnose if no changes or apply failed
        id: diagnose
        run: |
          set -e
          # 변경사항 존재 여부
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected after applying patch."
            echo "## n8n diagnose" > .n8n-diagnose.txt
            echo "Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> .n8n-diagnose.txt
            echo "GitHub Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> .n8n-diagnose.txt
            echo "" >> .n8n-diagnose.txt
            echo "First 120 lines of patch.diff:" >> .n8n-diagnose.txt
            head -n 120 patch.diff >> .n8n-diagnose.txt || true
            git add .n8n-diagnose.txt
          fi

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -z "$(git status --porcelain)" ]; then
            # 이 경우는 거의 없지만, 안전망
            echo "No changes to commit; creating heartbeat diagnose file."
            echo "Run: ${{ github.run_id }}" > .n8n-heartbeat.txt
            git add .n8n-heartbeat.txt
          fi
          git commit -m "${PR_TITLE}" || echo "Nothing to commit (already committed)."

      - name: Push branch
        run: |
          git push --set-upstream origin "$(git rev-parse --abbrev-ref HEAD)"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          title: ${{ env.PR_TITLE }}
          body: |
            Automated patch from n8n.

            - Base branch: `${{ env.BASE_BRANCH }}`
            - Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: ${{ steps.prep.outputs.BRANCH_NAME }}
          base: ${{ env.BASE_BRANCH }}
          labels: |
            bot
            auto-patch
          draft: false
